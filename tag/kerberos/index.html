<!DOCTYPE html>
<html lang="en">
<head>
		<title>Odd Bits &mdash; Posts tagged kerberos</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/css/style.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Odd Bits â€” Flux Atom"
			href="http://localhost:8000/" /> 
		<!--[if lte IE 8]><script src="http://localhost:8000/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background " >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="http://localhost:8000">Odd Bits</a></h1>
<h2 id="site-description">One of these things is not like the others</h2>		</div><!-- /#banner -->
		
		<div id="menu">
			<div class="menu-navigation-container">
				<ul id="menu-navigation" class="menu">
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/archives.html">archive</a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://twitter.com/larsks">larsks@twitter</a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://github.com/larsks">larsks@github</a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://webchat.freenode.net/">larsks@freenode</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
		</div><!-- /#menu -->
		
		<div class="page-title">
<div class="page-title">
	<h2>Posts tagged with <span>kerberos</span> &hellip;</h2>
</div>
		</div>
	
		<div id="contents">
<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="http://localhost:8000/posts/2010/06/29/kerberos-authenticated-queries-to-active-directory/">Tue 29 June 2010</a></div>
		<span class="byline">By <a href="http://localhost:8000/author/lars-kellogg-stedman.html">Lars Kellogg-Stedman</a></span>
    		<span class="tag-links"><strong>Tagged</strong>
 <a href="http://localhost:8000/tag/active_directory/index.html" rel="tag">active_directory</a>,  <a href="http://localhost:8000/tag/kerberos/index.html" rel="tag">kerberos</a>,  <a href="http://localhost:8000/tag/ldap/index.html" rel="tag">ldap</a>    		</span>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="http://localhost:8000/posts/2010/06/29/kerberos-authenticated-queries-to-active-directory/" title="Permalink to Kerberos authenticated queries to Active Directory" rel="bookmark">Kerberos authenticated queries to Active Directory</a>
		</h2>
		<div class="entry-content">
			<p>There are many guides out there to help you configure your Linux system as an LDAP and Kerberos client to an Active Directory server. Most of these guides solve the problem of authentication by embedding a username and password into a configuration file somewhere on your system. While this works, it presents some problems:</p>
<ul>
<li>If you use a common account for authentication from all of your Linux systems, a compromise on one system means updating the configuration of all of your systems.</li>
<li>If you don't want to use a common account, you need to provision a new account for each computer...</li>
<li>...which is silly, because if you join the system to Active Directory there is already a computer object associated with the system that can be used for authentication.</li>
</ul>
<p>This document describes how to configure a Linux system such that queries
generated by <a href="http://www.padl.com/OSS/nss_ldap.html">nss_ldap</a> will use either the current user's Kerberos
credentials, or, for the root user, credentials stored in a Kerberos
credentials cache.</p>
<ul>
<li>
<p>Your Linux system must have a valid <code>keytab</code> file.</p>
<p>A <code>keytab</code> is a file containing pairs of Kerberos principals and encrypted keys.</p>
<p>Joining Active Directory using Samba's <code>net ads join</code> will create the
necessary keytab. It is also possible to create the keytab on your Windows
domain controller and install it on your Linux systems. Instructions for
doing this are beyond the scope of this document.</p>
</li>
<li>
<p>Host objects in Active Directory must have a <code>userPrincipalName</code> attribute.</p>
<p>For example:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">ldapsearch</span> <span class="n">cn</span><span class="o">=</span><span class="n">dottiness</span> <span class="n">userPrincipalName</span>
<span class="nl">dn:</span> <span class="n">CN</span><span class="o">=</span><span class="n">DOTTINESS</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Computers</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="nl">userPrincipalName:</span> <span class="n">host</span><span class="o">/</span><span class="n">dottiness</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">@</span><span class="n">EXAMPLE</span><span class="p">.</span><span class="n">COM</span>
</pre></div>


<p>Active Directory <em>does not</em> automatically create a <code>userPrincipalName</code> when a new host object is provisioned. You will either need to provide this value manually or develop an automated process that will populate this field when provisioning new host objects.</p>
</li>
</ul>
<p>Kerberos credentials have a maximum usable lifetime. The cached credentials
used for root queries by <code>nss_ldap</code> must be refreshed periodically in order to
function.</p>
<p>You will need to install a crontab (e.g., in <code>/etc/cron.d</code>) that looks something
like this:</p>
<div class="highlight"><pre><span class="n">PATH</span><span class="o">=/</span><span class="n">bin</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">kerberos</span><span class="o">/</span><span class="n">bin</span>
<span class="err">@</span><span class="n">reboot</span> <span class="n">root</span> <span class="n">kinit</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ldap_cc</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">@</span><span class="n">hourly</span> <span class="n">root</span> <span class="n">kinit</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ldap_cc</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>


<p>This periodically reauthenticates to your domain controller used the cached
principal in the system keytab (<code>/etc/krb5.keytab</code>) and caches the credentials in
<code>/var/run/ldap_cc</code>.</p>
<p>You will need something similar to the following in <code>/etc/ldap.conf</code>:</p>
<div class="highlight"><pre><span class="cp"># This is your domain controller.</span>
<span class="n">uri</span> <span class="n">ldap</span><span class="o">:</span><span class="c1">//dc1.example.com</span>
<span class="n">base</span> <span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">scope</span> <span class="n">one</span>
<span class="n">referrals</span> <span class="n">no</span>
<span class="n">timelimit</span> <span class="mi">120</span>
<span class="n">bind_timelimit</span> <span class="mi">120</span>
<span class="n">idle_timelimit</span> <span class="mi">3600</span>
<span class="n">ldap_version</span> <span class="mi">3</span>

<span class="cp"># Authenticate using SASL for user and root queries.</span>
<span class="n">use_sasl</span> <span class="n">on</span>
<span class="n">rootuse_sasl</span> <span class="n">on</span>

<span class="cp"># Use SASL&#39;s gssapi (Kerberos) mechanism.</span>
<span class="n">sasl_mech</span> <span class="n">gssapi</span>

<span class="cp"># Use these cached credentials for root.</span>
<span class="n">krb5_ccname</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ldap_cc</span>

<span class="n">nss_base_group</span> <span class="n">ou</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">nss_base_passwd</span> <span class="n">ou</span><span class="o">=</span><span class="n">people</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">nss_initgroups_ignoreusers</span> <span class="n">root</span><span class="p">,</span><span class="n">ldap</span><span class="p">,</span><span class="n">named</span><span class="p">,</span><span class="n">avahi</span><span class="p">,</span><span class="n">haldaemon</span><span class="p">,</span><span class="n">dbus</span><span class="p">,</span><span class="n">radvd</span><span class="p">,</span><span class="n">tomcat</span><span class="p">,</span><span class="n">radiusd</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="n">mailman</span><span class="p">,</span><span class="n">nscd</span><span class="p">,</span><span class="n">gdm</span><span class="p">,</span><span class="n">polkituser</span>

<span class="cp"># These are common mappings for working with Active Directory.</span>
<span class="n">nss_map_attribute</span> <span class="n">uid</span> <span class="n">sAMAccountName</span>
<span class="n">nss_map_attribute</span> <span class="n">uniqueMember</span> <span class="n">member</span>
<span class="n">nss_map_objectclass</span> <span class="n">posixAccount</span> <span class="n">user</span>
<span class="n">nss_map_objectclass</span> <span class="n">posixGroup</span> <span class="n">group</span>
<span class="n">nss_map_objectclass</span> <span class="n">shadowAccount</span> <span class="n">user</span>

<span class="n">pam_login_attribute</span> <span class="n">sAMAccountName</span>
<span class="n">pam_member_attribute</span> <span class="n">member</span>
<span class="n">pam_password</span> <span class="n">ad</span>
<span class="n">pam_password_prohibit_message</span> <span class="n">Please</span> <span class="n">visit</span> <span class="n">http</span><span class="o">:</span><span class="c1">//password.example.com to change your password.</span>

<span class="n">pam_filter</span> <span class="n">objectclass</span><span class="o">=</span><span class="n">User</span>
</pre></div>


<p>The <code>use_sasl on</code> directive configures <code>nss_ldap</code> to use the Kerberos credentials
for the current user when looking up user/group/etc information. The
<code>rootuse_sasl on</code> attribute does the same thing for processes running as <code>root</code>.</p>
<p>Note that this configuration sets scope <code>one</code>, which means that <code>nss_ldap</code> <em>will
not</em> recurse down a directory tree. This is a performance optimization, not a
requirement.</p>
<h2>As an unprivileged user</h2>
<p>Before acquiring Kerberos credentials:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">getent</span> <span class="n">passwd</span> <span class="n">lars</span>
<span class="p">(</span><span class="n">times</span> <span class="n">out</span><span class="p">)</span>
</pre></div>


<p>Authenticate to Kerberos:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">kinit</span>
<span class="n">Password</span> <span class="k">for</span> <span class="n">lars</span><span class="err">@</span><span class="n">EXAMPLE</span><span class="p">.</span><span class="n">COM</span><span class="o">:</span>
</pre></div>


<p>With valid credentials:</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">getent</span> <span class="n">passwd</span> <span class="n">lars</span>
<span class="nl">lars:</span><span class="o">*:</span><span class="mi">500</span><span class="o">:</span><span class="mi">500</span><span class="o">:</span><span class="n">lars</span><span class="o">:</span><span class="err">\\</span><span class="n">emc00</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">\</span><span class="n">staff</span><span class="err">\</span><span class="n">l</span><span class="err">\</span><span class="n">lars</span><span class="err">\</span><span class="n">windows</span><span class="o">:</span>
</pre></div>


<h2>As root</h2>
<p>Before acquiring Kerberos credentials:</p>
<div class="highlight"><pre><span class="cp"># getent passwd lars</span>
<span class="p">(</span><span class="n">times</span> <span class="n">out</span><span class="p">)</span>
</pre></div>


<p>Update credentials cache from system keytab:</p>
<div class="highlight"><pre><span class="c"># kinit -k</span>
</pre></div>


<p>With valid credentials:</p>
<div class="highlight"><pre><span class="cp"># getent passwd lars</span>
<span class="nl">lars:</span><span class="o">*:</span><span class="mi">500</span><span class="o">:</span><span class="mi">500</span><span class="o">:</span><span class="n">lars</span><span class="o">:</span><span class="err">\\</span><span class="n">emc00</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">\</span><span class="n">staff</span><span class="err">\</span><span class="n">l</span><span class="err">\</span><span class="n">lars</span><span class="err">\</span><span class="n">windows</span><span class="o">:</span>
</pre></div>


<p>This configuration makes the operation of <code>nss_ldap</code> dependent on valid Kerberos
credentials. If a user remains logged in after her Kerberos credentials have
expired, she will experience degraded behavior, since many name lookup
operations will timeout. Similarly, local system accounts that do not have
valid Kerberos credentials will experience similar behavior (and will thus only
be able to see local users and groups).</p>
<!--
An alternate solution to this problem would run a local LDAP proxy that (a)
uses the system keytab to authenticate to AD, and (b) allows anonymous LDAP
queries from localhost. I will discuss this configuration in a future post.
-->
		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post--><div class="navigation">
</div>
		</div>
		
		<div id="footer">
			<p>Powered by <a href="http://getpelican.com">Pelican</a>, theme by <a href="http://bunnyman.info">tBunnyMan</a>.</p>
		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>